# Security pipeline: dependency audit + SAST (PHP).
# Separate from CI. No composer.lock enforcement (library best practice).
# No CodeQL (PHP not supported by CodeQL). Uses Semgrep for PHP SAST.
name: Security

on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch: {}
  push:
    branches: [main]
    paths:
      - 'composer.json'
      - 'composer.lock'
      - '**.php'
      - '.github/workflows/security.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  COMPOSER_AUDIT_FAIL_ON: 'high'

jobs:
  # ---------------------------------------------------------------------------
  # Composer: validate + install (with or without lock) + audit
  # ---------------------------------------------------------------------------
  audit:
    name: Composer audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate composer.json
        run: composer validate --strict --no-check-publish

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: dom, mbstring, json
          coverage: none

      - name: Get Composer cache dir
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: security-composer-${{ hashFiles('composer.lock') }}-${{ hashFiles('composer.json') }}

      - name: Resolve dependencies
        run: |
          if [ -f composer.lock ]; then
            composer install --prefer-dist --no-interaction --no-progress
          else
            composer update --prefer-dist --no-interaction --no-progress --no-install
            composer install --prefer-dist --no-interaction --no-progress
          fi

      - name: Run composer audit
        run: |
          composer audit --format=json --no-dev > /tmp/audit.json 2>/dev/null || true
          php -r "
            \$f = '/tmp/audit.json';
            if (!is_readable(\$f)) { echo 'No audit output.'; exit(0); }
            \$j = json_decode(file_get_contents(\$f), true);
            if (!isset(\$j['advisories']) || \$j['advisories'] === []) { echo 'No known vulnerabilities.'; exit(0); }
            \$fail = ['critical', 'high'];
            foreach (\$j['advisories'] as \$pkg => \$advs) {
              foreach (\$advs as \$a) {
                \$s = strtolower(\$a['severity'] ?? '');
                if (in_array(\$s, \$fail, true)) {
                  fwrite(STDERR, 'Security: ' . \$s . ' in ' . \$pkg . PHP_EOL);
                  exit(1);
                }
              }
            }
            echo 'Vulnerabilities found but none at HIGH/CRITICAL.'; exit(0);
          "

  # ---------------------------------------------------------------------------
  # SAST: Semgrep (PHP). CodeQL does not support PHP; Semgrep runs without token.
  # ---------------------------------------------------------------------------
  sast:
    name: Semgrep (PHP)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          docker run --rm -v "${{ github.workspace }}:/src" semgrep/semgrep semgrep scan \
            --config p/php \
            --config p/owasp-php \
            --no-git-ignore \
            /src
        # To fail the job on findings, add: --error
